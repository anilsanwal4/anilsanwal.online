<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quai Controller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="controller_styles.css">
  <link rel="icon" href="quai-logo.ico" type="image/x-icon">
  <!-- Apple touch icons (vector fallback) -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg">
  <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon.svg">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.svg">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon.svg">
  <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon.svg">
  <!-- Provide PNG fallback for some platforms (generated by ImageMagick) -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">
  <!-- Web app manifest + mobile meta -->
  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#2b0211">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- PNG icon fallbacks for Apple/Android (generate with ImageMagick) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png">
  <style>
    /* Responsive tweaks for the header controls */
    .card-header.flex-between { display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; }
    .card-header .left { display:flex; gap:12px; align-items:center; min-width:0; flex:1 1 auto; }
    .rpc-input { flex:1 1 240px; min-width:0; max-width:100%; padding:8px 12px; border-radius:18px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:inherit; }
    .header-actions-btns { display:flex; gap:8px; align-items:center; white-space:nowrap; }
    .pill { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .nav-pill { padding:6px 10px; border-radius:8px; background:rgba(255,37,58,0.08); color:inherit; text-decoration:none; border:1px solid rgba(255,37,58,0.08); }
    @media (max-width:600px) {
      .rpc-input { flex-basis:140px; }
      .card-header.flex-between { align-items:flex-start; }
      .pill { order:3; }
      .header-actions-btns { order:2; }
      .card-header .left { order:1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img src="quai-logo.png" alt="Quai logo" class="logo" />
      <div class="header-main">
        <h1>
          Quai Controller Dashboard
        </h1>
      </div>
      <div class="header-actions">
        <a href="index.html" class="nav-pill">Solo Mining Dashboard</a>
        <a
          href="https://github.com/Clonners/Controller-view-Quai-Network"
          target="_blank"
          rel="noopener noreferrer"
          class="github-pill"
        >
          <span class="github-icon" aria-hidden="true">
            <svg viewBox="0 0 16 16" width="16" height="16" fill="#e5e7eb">
              <path fill-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
                0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
                -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95
                0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.62 7.62 0 0 1 8 3.13c.68.01
                1.36.09 2 .26 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15
                0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2
                0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z">
              </path>
            </svg>
          </span>
          <span class="github-label">GitHub</span>
        </a>

        <button id="donation-pill" class="donate-pill" type="button">
          <span class="donate-heart">♥</span>
          <span class="donate-label">Donate</span>
          <span class="donate-address">0x0042843bC5C3fcAFda51d2c6BB17d47370567C9a</span>
        </button>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="chart-card">
        <div class="card-header flex-between">
          <div class="left">
            <input class="rpc-input" type="text" id="rpc-url" placeholder="RPC endpoint (prime)" value="https://prime.bitquai.live" spellcheck="false" />
            <div class="header-actions-btns">
              <button id="refresh-btn"><span>Refresh</span></button>
              <button id="auto-btn" class="secondary">Auto (10s)</button>
            </div>
          </div>
          <div class="pill">
            <span class="pill-dot" id="conn-dot" style="background:#22c55e;"></span>
            <span id="conn-label">Prime RPC connected</span>
          </div>
        </div>

        <div class="chart-wrapper" style="position: relative; min-height: 300px; width: 100%;">
          <div id="chart-loading-overlay" class="chart-loading-overlay" style="display: none;">
            <div class="spinner-large"></div>
            <div class="spinner-text">Loading chart data...</div>
          </div>
          <canvas id="ddstar-chart"></canvas>
        </div>

        <div class="legend">
          <span class="legend-item">
            <span class="legend-swatch"></span> d (normalized difficulty, Prime)
          </span>
          <span class="legend-item">
            <span class="legend-swatch alt"></span> d* (window average)
          </span>
          <span class="legend-item">
            <span class="legend-swatch delta"></span> ΔkQuai/kQuai (%) estimate
          </span>
        </div>

        <div class="status-bar">
          <div>
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">No data yet.</span>
          </div>
          <div class="status-bar-right">
            <span class="status-tag">
              <span class="status-dot-mini"></span>
              <span>
                d*/d &gt; 1 ⇒ <strong>FX helps Qi</strong> (more Quai per 1 Qi)
              </span>
            </span>
            <span class="status-tag">
              <span class="status-dot-mini"></span>
              <span>
                d*/d &lt; 1 ⇒ <strong>FX helps Quai</strong> (less Quai per 1 Qi)
              </span>
            </span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Current state (Prime)</div>
            <div class="card-subtitle">
              Metrics from the latest Prime blocks (via Prime RPC).
            </div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-title">Latest Prime block</div>
            <div class="metric-main">
              <div class="metric-value" id="metric-block">–</div>
              <div class="metric-unit">#</div>
            </div>
            <div class="metric-footer">
              <span id="metric-ts">timestamp: –</span>
              <span class="metric-pill">
                <span class="dot" id="metric-side-dot"></span>
                <span id="metric-side">no signal</span>
              </span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-title">d* / d (last point)</div>
            <div class="metric-main">
              <div class="metric-value" id="metric-ratio">–</div>
              <div class="metric-unit">ratio</div>
              <span class="metric-badge" id="metric-ratio-badge">–</span>
            </div>
            <div class="metric-footer">
              <span id="metric-ratio-text">Waiting for data...</span>
              <span class="metric-pill">
                <span class="dot" id="metric-ratio-dot"></span>
                <span id="metric-ratio-side">–</span>
              </span>
            </div>
          </div>
        </div>

        <div class="metrics-grid" style="margin-top:10px;">
          <div class="metric-card">
            <div class="metric-title metric-title-exrate">
              <span class="metric-title-exrate-main">Exchange Rate</span>
              <span class="metric-title-exrate-sub">(Qi → Quai)</span>
            </div>
            <div class="metric-main metric-main-exrate">
              <span class="metric-prefix">1 Qi =</span>
              <div class="metric-value" id="metric-exrate">–</div>
              <span class="metric-unit">Quai</span>
            </div>
            <div class="metric-footer">
              
              <span style="display:none;">
                Prime exchangeRate: <code id="metric-exrate-hex">–</code>
              </span>
              <span class="metric-pill">
                <span class="dot" style="background:#22c55e;"></span>
                <span>From Prime RPC</span>
              </span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-title">Estimated ΔkQuai/kQuai</div>
            <div class="metric-main">
              <div class="metric-value" id="metric-dk">–</div>
              <div class="metric-unit">/ block</div>
            </div>
            <div class="metric-footer">
              <span id="metric-dk-text">Controller α = 0.001 (per spec)</span>
              <span class="metric-pill">
                <span class="dot" id="metric-dk-dot"></span>
                <span id="metric-dk-side">–</span>
              </span>
            </div>
          </div>
        </div>

        
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Conversion & Discounts</div>
            <div class="card-subtitle">Live conversion flow, kQuai discount and cubic preview</div>
          </div>
        </div>

        <div class="metrics-grid" style="margin-top:8px;">
          <div class="metric-card">
            <div class="metric-title">Conversion Flow (EMA)</div>
            <div class="metric-main">
              <div class="metric-value" id="metric-conversionflow">–</div>
              <div class="metric-unit">Quai</div>
            </div>
            <div class="metric-footer">
              <span class="metric-pill"><span class="dot" style="background:#22c55e"></span><span>From Prime RPC</span></span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-title">kQuai Discount</div>
            <div class="metric-main">
                <div class="metric-value" id="metric-kquai">–</div>
                <div class="metric-unit"></div>
              </div>
            <div class="metric-footer">
              <span id="metric-kquai-direction">direction: –</span>
              <span class="metric-pill"><span class="dot" style="background:#22c55e"></span><span>From Prime RPC</span></span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-title">Cubic Discount (preview)</div>
            <div class="metric-main">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <input id="cubic-amount" class="conversion-input" placeholder="Amount" style="width:120px" />
                <select id="cubic-isqi" style="padding:6px;border-radius:6px">
                  <option value="true">Qi</option>
                  <option value="false">Quai</option>
                </select>
              </div>
            </div>
            <div class="metric-footer">
              <div>After cubic: <strong id="cubic-result">–</strong></div>
              <div>Discount: <code id="cubic-discount">–</code></div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="conversion-card">
        <div class="card-header">
          <h3 class="card-title">Conversion Calculator</h3>
        </div>
        <div class="conversion-container">
          <div class="conversion-input-group">
            <label for="conversion-amount">Amount</label>
            <input type="text" id="conversion-amount" class="conversion-input" placeholder="Enter amount" />
          </div>
          
          <div class="conversion-direction">
            <button id="swap-direction-btn" class="swap-btn" title="Swap direction">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16"/>
              </svg>
            </button>
            <div class="direction-labels">
              <span id="from-currency">Qi</span>
              <span class="arrow">→</span>
              <span id="to-currency">Quai</span>
            </div>
          </div>

          <div class="conversion-result">
            <div class="result-label">You will receive:</div>
            <div class="result-value" id="conversion-result">–</div>
            <div class="result-details" id="conversion-details"></div>
          </div>

          <button id="calculate-btn" class="calc-btn">Calculate</button>
        </div>
      </section>
    </div>

    <footer>
      
    </footer>
  </div>

  <!-- Diagnostic loader: prefer CDN, fallback to local vendor, then load controller_main.js -->
  <div id="libStatus" style="position:fixed;right:12px;top:12px;background:rgba(0,0,0,0.6);color:#fff;padding:8px 10px;border-radius:8px;z-index:9999;font-size:0.85rem;box-shadow:0 6px 18px rgba(0,0,0,0.6);">Loading libraries...</div>
  <script>
    (function(){
      function el(text){ return document.getElementById(text); }
      function setStatus(msg, warn){
        try{ const b = el('libStatus'); if(b) b.textContent = msg; if(warn) console.warn(msg); else console.info(msg); } catch(e){}
      }
      function loadScript(src){
        return new Promise(function(resolve, reject){
          var s = document.createElement('script');
          s.src = src;
          // Load the app entry as an ES module so module files with `export`/`import` parse correctly
          if (/main\.js$/.test(src)) {
            s.type = 'module';
          }
          s.async = false;
          s.onload = function(){ setStatus('Loaded: ' + src); resolve(); };
          s.onerror = function(err){ setStatus('Failed to load: ' + src, true); reject(new Error('Failed to load ' + src)); };
          document.head.appendChild(s);
        });
      }
      async function ensure() {
        try {
          setStatus('Loading Decimal from vendor...');
          await loadScript('vendor/decimal.min.js');
          setStatus('Decimal loaded');
          setStatus('Loading Chart.js from vendor...');
          await loadScript('vendor/chart.min.js');
          setStatus('Chart.js loaded');
        } catch (e) {
          setStatus('Failed to load vendor libraries', true);
          console.error('Vendor library load failed', e);
        }
        try {
          setStatus('Loading main.js');
          await loadScript('main.js');
          setStatus('');
          try { const b = el('libStatus'); if (b) b.style.display = 'none'; } catch(e) {}
        } catch (e) {
          console.error('Failed to load controller_main.js', e);
          setStatus('Failed to load controller_main.js — check console', true);
        }
      }
      ensure().catch(function(err){ console.error('Loader error', err); setStatus('Loader error — check console', true); });
    })();
  </script>
</body>
</html>